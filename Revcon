Private session As blpapicomLib.sessionSub m_analyse3()Dim start_date As Date: start_date = CDate(Sh_InputVol.Range("F3"))Dim end_date As Date: end_date = CDate(Sh_InputVol.Range("F4"))''' Init bloomSet session = New blpapicomLib.sessionsession.Startsession.OpenService ("//blp/refdata") ''' Init DBDim strOpenPwd As String: strOpenPwd = ";pwd=123456"Dim opt_db As DatabaseSet opt_db = OpenDatabase(Sh_InputVol.Range("E14"), _                            Options:=True, _                            ReadOnly:=False, _                            Connect:=strOpenPwd)Dim global_results() As VariantReDim global_results(Sh_InputVol.Range(Cells(3, 2), Cells(3, 2).End(xlDown)).Count - 1, 4)Dim small_tick As StringDim dss As Stringi = 0For Each cell In Sh_InputVol.Range(Cells(3, 2), Cells(3, 2).End(xlDown))small_tick = CStr(cell)global_results(i, 0) = small_tick'global_results(i, 1) = CStr(cell.Offset(0, 1))'''' 52Wk RSI analysis ''''    Dim ftwo_RSI() As Variant        Dim sec() As String: ReDim sec(0): sec(0) = small_tick    Dim champs() As Variant: ReDim champs(0): champs(0) = "RSI_PX_52WEEK"        ftwo_RSI = M_BloomFunctions.M_GetStaticData(sec(), champs(), session)    If IsEmpty(ftwo_RSI(0, 0)) ThenGoTo 2End If    global_results(i, 1) = CDbl(ftwo_RSI(0, 0)) / 100'''' 6M volatility analysis ''''    Dim histo_6M() As Variant        histo_6M = get_histo_datas(small_tick, "6M_100", start_date, end_date, opt_db, dss)        '''' 6M vol percentrank(last) over one year    global_results(i, 2) = percent_rank(histo_6M(), start_date, end_date, dss)'''' Skew Analysis ''''    '''' 90    Dim histo_ninety() As Variant    histo_ninety = get_histo_datas(small_tick, "6M_90", start_date, end_date, opt_db, dss)        '''' 100    Dim histo_atm() As Variant    histo_atm = get_histo_datas(small_tick, "6M_100", start_date, end_date, opt_db, dss)        Dim v_skew() As Variant        v_skew = skew(histo_ninety, histo_atm, histo_atm)        global_results(i, 3) = percent_rank(v_skew(), start_date, end_date, dss)    '''' Yield Analysis ''''    Dim yiel() As Variant        champs(0) = "EQY_DVD_YLD_EST"        yiel = M_BloomFunctions.M_GetStaticData(sec(), champs(), session)    global_results(i, 4) = WorksheetFunction.Min(0.1, CDbl(yiel(0, 0) / 100)) * 102:    i = i + 1        Application.StatusBar = i    Next cellCall disp(global_results)End SubSub disp(main_results As Variant)Dim ft_weight As Double: ft_weight = Sh_InputVol.Range("F29")Dim atm_weight As Double: atm_weight = Sh_InputVol.Range("F30")Dim skew_weight As Double: skew_weight = Sh_InputVol.Range("F31")Dim div_weight As Double: div_weight = Sh_InputVol.Range("F32")With Sh_RevCon.Cells.ClearContents.Cells.ClearFormats.Range("A1").Value = "Ticker".Range("B1").Value = "52Wk RSI".Range("C1").Value = "PercentRank 6M ATM IV".Range("D1").Value = "PercentRank 6M 100/90 Skew".Range("E1").Value = "Div Yield x 10".Range("F1").Value = "Global Score"n = 0For i = 0 To UBound(main_results, 1)If IsEmpty(main_results(i, 1)) Then '' = "No data" Or main_results(i, 1) = "Ticker not found" Or _        main_results(i, 1) = "Last date not loaded" ThenElse'If CDbl(main_results(i, 2)) = 1 Thenn = n + 1.Cells(n + 1, 1).Value = main_results(i, 0).Cells(n + 1, 2).Value = main_results(i, 1).Cells(n + 1, 2).NumberFormat = "##0.00%".Cells(n + 1, 3).Value = main_results(i, 2).Cells(n + 1, 3).NumberFormat = "##0.00%".Cells(n + 1, 4).Value = main_results(i, 3).Cells(n + 1, 4).NumberFormat = "##0.00%".Cells(n + 1, 5).Value = main_results(i, 4).Cells(n + 1, 5).NumberFormat = "##0.00%".Cells(n + 1, 6).Value = (1 - .Cells(n + 1, 2).Value) * ft_weight + .Cells(n + 1, 3).Value * atm_weight _            + .Cells(n + 1, 4).Value * skew_weight + .Cells(n + 1, 5).Value * div_weight.Cells(n + 1, 6).NumberFormat = "##0.00%"'End IfEnd IfNext i.ActivateRange("A:F").SelectSelection.Sort Key1:=Range("F2"), Order1:=xlDescending, Header:=xlGuess, _    OrderCustom:=1, MatchCase:=False, Orientation:=xlTopToBottom, _    DataOption1:=xlSortNormalformat_resultsEnd WithEnd Sub
