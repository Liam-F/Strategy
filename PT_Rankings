Sub pt_table_rankings()Dim strOpenPwd As String: strOpenPwd = ";pwd=123456"Dim opt_db As DatabaseSet opt_db = OpenDatabase(Sh_PtRankings.Range("A21"), _                            Options:=True, _                            ReadOnly:=False, _                            Connect:=strOpenPwd)Dim dss As StringDim prctrank As VariantDim mmin As VariantDim mmax As VariantDim start_date As Date: start_date = Sh_PtRankings.Range("B3")Dim end_date As Date: end_date = Sh_PtRankings.Range("B4")Dim mat1: mat1 = Sh_PtRankings.Range("B7")Dim mney1: mney1 = Sh_PtRankings.Range("B8")Dim mat2: mat2 = Sh_PtRankings.Range("B11")Dim mney2: mney2 = Sh_PtRankings.Range("B12")Dim moneyness1 As String'If Replace(mney1, "%", "") * 100 = 100 Then'moneyness1 = "ATM"'Elsemoneyness1 = CStr(Replace(mney1, "%", "") * 100)'End IfDim moneyness2 As String'If Replace(mney2, "%", "") * 100 = 100 Then'moneyness2 = "ATM"'Elsemoneyness2 = CStr(Replace(mney2, "%", "") * 100)'End IfDim tick1 As StringDim tick2 As StringFor g = 4 To 500 Step 6If Cells(1, g) <> "" Then    For f = 3 To Range(Cells(3, g), Cells(3, g).End(xlDown)).Count + 2        If Cells(f, g) <> "" Then        tick1 = Cells(f, g) & " US Equity"    tick2 = Cells(f, g + 1) & " US Equity"        Dim histo_vm1() As Variant        histo_vm1 = get_histo_datas(tick1, mat1 & "M_" & moneyness1, start_date, end_date, opt_db, dss)        If dss = 1 Then    prctrank = ""    mmin = ""    mmax = ""'    MsgBox ("Error: no data for this ticker")    GoTo 2    End If            Dim histo_vm2() As Variant        histo_vm2 = get_histo_datas(tick2, mat2 & "M_" & moneyness2, start_date, end_date, opt_db, dss)        If dss = 1 Then    prctrank = ""    mmin = ""    mmax = ""'    MsgBox ("Error: no data for this ticker")    GoTo 2    End If            Dim glob() As Variant            If UBound(histo_vm1, 1) = UBound(histo_vm2, 1) Then            ReDim glob(UBound(histo_vm1, 1))                For i = 0 To UBound(glob, 1)        glob(i) = CDbl(histo_vm1(i, 1) - histo_vm2(i, 1))        Next i        Else            If UBound(histo_vm1, 1) > UBound(histo_vm2, 1) Then                ReDim glob(UBound(histo_vm1, 1))            For i = 0 To UBound(histo_vm1, 1)                glob(i) = histo_vm1(i, 0)                    For j = 0 To UBound(histo_vm2, 1)                            If histo_vm1(i, 0) = histo_vm2(j, 0) Then                glob(i) = CDbl(histo_vm1(i, 1) - histo_vm2(j, 1))                Exit For                Else                glob(i) = ""                End If                        Next j                    Next i                Else                ReDim glob(UBound(histo_vm2, 1))                For i = 0 To UBound(histo_vm2, 1)                glob(i) = histo_vm2(i, 0)                    For j = 0 To UBound(histo_vm1, 1)                            If histo_vm2(i, 0) = histo_vm1(j, 0) Then                glob(i) = CDbl(histo_vm1(j, 1) - histo_vm2(i, 1))                Exit For                Else                glob(i) = ""                End If                        Next j                    Next i                End If            End If        If glob(UBound(glob)) <> "" Then    prctrank = WorksheetFunction.PercentRank(glob, glob(UBound(glob)))    Else    prctrank = ""    GoTo 2    End If        mmin = WorksheetFunction.Min(glob)    mmax = WorksheetFunction.Max(glob)        2:        Cells(f, g + 2) = prctrank    Cells(f, g + 3) = mmin    Cells(f, g + 4) = mmax        Else    Exit For    End If        Next f        Else        Exit For        End If        lstline = Range(Cells(2, g), Cells(2, g).End(xlDown)).Count + 1        Range(Cells(2, g), Cells(lstline, g + 4)).Select    Selection.Sort Key1:=Range(Cells(2, g + 2), Cells(2, g + 2)), Order1:=xlDescending, Header:=xlGuess, _    OrderCustom:=1, MatchCase:=False, Orientation:=xlTopToBottom, _    DataOption1:=xlSortNormal        '''' format line    Range(Cells(3, g), Cells(lstline, g + 4)).Select    Selection.Interior.ColorIndex = xlNone    For h = 3 To lstline Step 2    Range(Cells(h, g), Cells(h, g + 4)).Interior.Color = RGB(200, 255, 200)    Next h    Next gEnd Sub
